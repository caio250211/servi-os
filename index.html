<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insect Control Tupí | Sistema de Gestão</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #D32F2F;        /* Vermelho Institucional */
            --primary-dark: #b71c1c;
            --bg-body: #121212;        /* Fundo Super Dark */
            --bg-card: #1E1E1E;        /* Cinza Carvão */
            --bg-input: #2C2C2C;
            --text-main: #E0E0E0;
            --text-muted: #A0A0A0;
            --success: #4CAF50;
            --warning: #FFC107;
            --danger: #FF5252;
            --border-radius: 8px;
            --sidebar-width: 260px;
            --shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--primary-dark) 0%, var(--primary) 100%);
            display: flex; flex-direction: column; padding: 20px;
            box-shadow: 4px 0 15px rgba(0,0,0,0.4); z-index: 10;
        }
        .brand { text-align: center; margin-bottom: 40px; }
        .brand img { width: 80px; height: 80px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.2); padding: 4px; background: white; object-fit: contain; }
        .brand h2 { font-size: 16px; margin-top: 15px; font-weight: 700; letter-spacing: 0.5px; color: white; text-transform: uppercase; }

        .menu-item {
            padding: 14px 18px; border-radius: var(--border-radius); color: rgba(255,255,255,0.7);
            cursor: pointer; transition: all 0.3s; display: flex; align-items: center; margin-bottom: 5px; text-decoration: none;
        }
        .menu-item i { width: 25px; font-size: 18px; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.15); color: white; transform: translateX(5px); }
        .menu-footer { margin-top: auto; }

        /* --- MAIN CONTENT --- */
        .main { flex: 1; padding: 30px 40px; overflow-y: auto; position: relative; }
        
        .header-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header-title h1 { margin: 0; font-size: 28px; font-weight: 600; }
        .date-display { font-size: 14px; color: var(--text-muted); }

        /* --- CARDS RESUMO --- */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card {
            background: var(--bg-card); padding: 25px; border-radius: var(--border-radius);
            box-shadow: var(--shadow); position: relative; overflow: hidden;
            border-bottom: 4px solid transparent; transition: transform 0.2s;
        }
        .kpi-card:hover { transform: translateY(-3px); }
        .kpi-title { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 10px; font-weight: 600; }
        .kpi-value { font-size: 28px; font-weight: 700; color: white; }
        .kpi-card.blue { border-color: #2196F3; }
        .kpi-card.green { border-color: var(--success); }
        .kpi-card.yellow { border-color: var(--warning); }

        /* --- FORMULÁRIO --- */
        .action-panel { background: var(--bg-card); padding: 20px; border-radius: var(--border-radius); margin-bottom: 30px; border: 1px solid #333; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end; }
        
        input, select {
            width: 100%; background: var(--bg-input); border: 1px solid #444;
            color: white; padding: 12px; border-radius: 6px; font-size: 14px;
        }
        input:focus { border-color: var(--primary); }
        
        .btn-add {
            background: var(--success); color: white; border: none; padding: 12px;
            font-weight: 600; border-radius: 6px; cursor: pointer; text-transform: uppercase;
            transition: 0.2s; height: 42px;
        }
        .btn-add:hover { background: #43A047; }

        /* --- TABELA --- */
        .table-container { background: var(--bg-card); border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--shadow); }
        table { width: 100%; border-collapse: collapse; }
        th { background: #252525; color: var(--text-muted); font-size: 12px; text-transform: uppercase; padding: 18px; text-align: left; }
        td { padding: 16px 18px; border-bottom: 1px solid #2C2C2C; font-size: 14px; color: var(--text-main); }
        tr:hover td { background: #252525; }
        
        .badge { padding: 6px 12px; border-radius: 50px; font-size: 11px; font-weight: 700; cursor: pointer; text-transform: uppercase; }
        .badge.pago { background: rgba(76, 175, 80, 0.2); color: #81c784; border: 1px solid #2e7d32; }
        .badge.pendente { background: rgba(255, 193, 7, 0.15); color: #ffd54f; border: 1px solid #ff8f00; }
        
        .btn-trash { background: none; border: none; color: #666; cursor: pointer; transition: 0.2s; }
        .btn-trash:hover { color: var(--danger); }

        /* --- LOADING --- */
        .loader-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(18,18,18,0.8); display: none; justify-content: center; align-items: center; z-index: 50;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- LOGIN MODAL --- */
        .modal-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: var(--bg-card); padding: 40px; border-radius: 12px; width: 320px; text-align: center; border-top: 4px solid var(--primary); }
        .login-box h2 { margin-top: 0; color: white; }
        .login-box button { width: 100%; background: var(--primary); color: white; padding: 12px; border: none; border-radius: 6px; margin-top: 15px; cursor: pointer; font-weight: bold; }

        /* --- ESTATÍSTICAS --- */
        .stats-view { display: none; }
        .stats-view.active { display: block; }
        .bar-bg { background: #333; height: 12px; border-radius: 10px; margin: 15px 0; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--success); width: 0%; transition: 1s ease-out; }
    </style>
</head>
<body>

    <div id="loginModal" class="modal-wrap">
        <div class="login-box">
            <div class="brand" style="margin-bottom: 20px;">
                <img src="logo.png.JPG" alt="Insect">
            </div>
            <h2>Acesso Restrito</h2>
            <p style="color: #666; font-size: 13px; margin-bottom: 20px;">Gestão Insect Control Tupí</p>
            <input type="email" id="email" placeholder="Email administrativo" style="margin-bottom: 10px;">
            <input type="password" id="senha" placeholder="Senha">
            <button onclick="fazerLogin()">ACESSAR SISTEMA</button>
        </div>
    </div>

    <div id="app" style="display: none; width: 100%; height: 100%;">
        <nav class="sidebar">
            <div class="brand">
                <img src="logo.png.JPG" alt="Logo">
                <h2>Insect Control<br>Tupí</h2>
            </div>
            
            <a class="menu-item active" onclick="navegar('2026')">
                <i class="fas fa-calendar-alt"></i> Serviços 2026
            </a>
            <a class="menu-item" onclick="navegar('2025')">
                <i class="fas fa-history"></i> Serviços 2025
            </a>
            <a class="menu-item" onclick="navegar('stats')">
                <i class="fas fa-chart-line"></i> Estatísticas
            </a>

            <div class="menu-footer">
                <a class="menu-item" onclick="sair()">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </a>
            </div>
        </nav>

        <main class="main">
            <div id="loader" class="loader-overlay"><div class="spinner"></div></div>

            <div id="view-lista" class="active">
                <div class="header-title">
                    <h1 id="tituloPagina">Painel 2026</h1>
                    <span class="date-display" id="dataHoje"></span>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card blue">
                        <div class="kpi-title">Total Ordens</div>
                        <div class="kpi-value" id="kpiQtd">0</div>
                    </div>
                    <div class="kpi-card green">
                        <div class="kpi-title">Faturamento Realizado</div>
                        <div class="kpi-value" id="kpiFat">R$ 0,00</div>
                    </div>
                    <div class="kpi-card yellow">
                        <div class="kpi-title">Previsão Pendente</div>
                        <div class="kpi-value" id="kpiPend">R$ 0,00</div>
                    </div>
                </div>

                <div class="action-panel">
                    <form id="formAdd" class="form-row">
                        <input type="date" id="inpData" required>
                        <input type="text" id="inpCli" placeholder="Nome do Cliente" required>
                        <input type="text" id="inpLocal" placeholder="Local / Bairro" required>
                        <input type="text" id="inpServ" placeholder="Serviço Realizado" required>
                        <input type="number" id="inpVal" placeholder="Valor (0.00)" step="0.01" required>
                        <button type="submit" class="btn-add"><i class="fas fa-plus"></i> Lançar</button>
                    </form>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Cliente</th>
                                <th>Local</th>
                                <th>Serviço</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th style="text-align: right;">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaCorpo">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="view-stats" class="stats-view">
                <div class="header-title">
                    <h1>Inteligência de Negócio</h1>
                    <select id="filtroAnoStat" style="width: 150px;" onchange="atualizarStats()">
                        <option value="2026">Base 2026</option>
                        <option value="2025">Base 2025</option>
                    </select>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-title">Ticket Médio</div>
                        <div class="kpi-value" id="statTicket">R$ 0,00</div>
                    </div>
                    <div class="kpi-card green">
                        <div class="kpi-title">Taxa de Recebimento</div>
                        <div class="kpi-value" id="statPerc">0%</div>
                        <div class="bar-bg"><div id="statBar" class="bar-fill"></div></div>
                    </div>
                </div>

                <div class="action-panel" style="margin-top: 20px;">
                    <h3 style="color: var(--text-muted); margin-top: 0; text-transform: uppercase; font-size: 12px;">Top Clientes (Volume Financeiro)</h3>
                    <div id="rankingClientes"></div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, query, where, updateDoc } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

        // CONFIGURAÇÃO
        const firebaseConfig = {
            apiKey: "AIzaSyCIU7yiuI1uXfJWv6MoGYTv6ylqhzQhscA",
            authDomain: "insectcontrol-54785.firebaseapp.com",
            projectId: "insectcontrol-54785",
            storageBucket: "insectcontrol-54785.appspot.com",
            messagingSenderId: "299720867487",
            appId: "1:299720867487:web:cdcff964efc45755496caa"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const colRef = collection(db, "servicos");

        let dadosGlobais = [];
        let usuarioAtual = null;
        let anoSelecionado = "2026";
        let viewAtual = "lista"; // 'lista' ou 'stats'

        // --- SISTEMA DE DATAS (NORMALIZAÇÃO) ---
        // Pega uma data suja (29/12/2025 ou 2025-12-29) e retorna o ANO como string
        function extrairAno(dataStr) {
            if (!dataStr) return "0000";
            // Procura por 4 dígitos seguidos (ex: 2025)
            const match = dataStr.match(/20\d{2}/); 
            return match ? match[0] : "0000";
        }

        // Formata para exibir bonitinho na tabela (DD/MM/AAAA)
        function formatarDataBR(dataStr) {
            if (dataStr.includes('-')) {
                // Se vier YYYY-MM-DD
                const partes = dataStr.split('-');
                return `${partes[2]}/${partes[1]}/${partes[0]}`;
            }
            return dataStr; // Já está DD/MM/AAAA ou similar
        }

        // Converte dataStr para objeto Date para ordenação correta
        function dataParaObjeto(dataStr) {
            if(dataStr.includes('/')) {
                const [d, m, y] = dataStr.split('/');
                return new Date(`${y}-${m}-${d}`);
            }
            return new Date(dataStr);
        }

        // --- AUTH ---
        window.fazerLogin = () => {
            const e = document.getElementById('email').value;
            const s = document.getElementById('senha').value;
            signInWithEmailAndPassword(auth, e, s).catch(err => alert("Erro: " + err.message));
        };
        window.sair = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                usuarioAtual = user.email;
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                carregarDados();
                
                // Seta data de hoje no topo
                const hoje = new Date();
                document.getElementById('dataHoje').innerText = hoje.toLocaleDateString('pt-BR', {weekday: 'long', day:'numeric', month:'long'});
            } else {
                document.getElementById('app').style.display = 'none';
                document.getElementById('loginModal').style.display = 'flex';
            }
        });

        // --- CORE: CARREGAR E PROCESSAR ---
        async function carregarDados() {
            if (!usuarioAtual) return;
            mostrarLoading(true);

            try {
                const q = query(colRef, where("usuario", "==", usuarioAtual));
                const snapshot = await getDocs(q);
                
                // Mapeia e já limpa os valores numéricos
                dadosGlobais = snapshot.docs.map(doc => {
                    const d = doc.data();
                    // Limpeza bruta de valor (tira R$, espaços, troca virgula por ponto)
                    let valorLimpo = String(d.valor)
                        .replace('R$', '')
                        .replace(/\s/g, '')
                        .replace(',', '.');
                    
                    return {
                        id: doc.id,
                        ...d,
                        valorNumerico: parseFloat(valorLimpo) || 0,
                        anoReal: extrairAno(d.data) // Campo virtual calculado
                    };
                });

                renderizarTela();
            } catch (error) {
                console.error("Erro ao carregar:", error);
                alert("Erro de conexão. Verifique o console.");
            } finally {
                mostrarLoading(false);
            }
        }

        // --- RENDERIZAÇÃO INTELIGENTE ---
        function renderizarTela() {
            if (viewAtual === 'lista') {
                atualizarListaESumario();
            } else {
                atualizarStats();
            }
        }

        function atualizarListaESumario() {
            document.getElementById('view-lista').style.display = 'block';
            document.getElementById('view-stats').style.display = 'none';
            document.getElementById('tituloPagina').innerText = `Gestão de Serviços ${anoSelecionado}`;

            const tbody = document.getElementById('tabelaCorpo');
            tbody.innerHTML = '';

            // Filtra pelo ano selecionado usando o campo "anoReal" calculado
            let dadosFiltrados = dadosGlobais.filter(item => item.anoReal === anoSelecionado);
            
            // Ordena do mais recente para o mais antigo
            dadosFiltrados.sort((a, b) => dataParaObjeto(b.data) - dataParaObjeto(a.data));

            let totalQtd = 0;
            let totalFat = 0;
            let totalPen = 0;

            dadosFiltrados.forEach(item => {
                totalQtd++;
                if (item.status === 'Pago') {
                    totalFat += item.valorNumerico;
                } else {
                    totalPen += item.valorNumerico;
                }

                // Cria linha da tabela
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatarDataBR(item.data)}</td>
                    <td><strong>${item.cliente.toUpperCase()}</strong></td>
                    <td>${item.local}</td>
                    <td>${item.tipo}</td>
                    <td>R$ ${item.valorNumerico.toFixed(2)}</td>
                    <td><span class="badge ${item.status === 'Pago' ? 'pago' : 'pendente'}" 
                        onclick="window.alterarStatus('${item.id}', '${item.status}')">${item.status}</span></td>
                    <td style="text-align: right;">
                        <button class="btn-trash" onclick="window.deletar('${item.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.innerHTML += tr.outerHTML;
            });

            // Atualiza os cards coloridos
            document.getElementById('kpiQtd').innerText = totalQtd;
            document.getElementById('kpiFat').innerText = `R$ ${totalFat.toFixed(2)}`;
            document.getElementById('kpiPend').innerText = `R$ ${totalPen.toFixed(2)}`;
        }

        window.atualizarStats = () => {
            const anoStat = document.getElementById('filtroAnoStat').value;
            const dadosAno = dadosGlobais.filter(item => item.anoReal === anoStat);
            
            let fat = 0, rec = 0;
            const clientesMap = {};

            dadosAno.forEach(d => {
                fat += d.valorNumerico;
                if(d.status === 'Pago') rec += d.valorNumerico;
                
                // Ranking Clientes
                const nome = d.cliente.toUpperCase().trim();
                clientesMap[nome] = (clientesMap[nome] || 0) + d.valorNumerico;
            });

            // Ticket Médio e Porcentagem
            const ticket = dadosAno.length > 0 ? fat / dadosAno.length : 0;
            const percent = fat > 0 ? (rec / fat) * 100 : 0;

            document.getElementById('statTicket').innerText = `R$ ${ticket.toFixed(2)}`;
            document.getElementById('statPerc').innerText = `${percent.toFixed(1)}%`;
            document.getElementById('statBar').style.width = `${percent}%`;

            // Renderiza Lista de Top Clientes
            const rankingDiv = document.getElementById('rankingClientes');
            rankingDiv.innerHTML = '';
            
            Object.entries(clientesMap)
                .sort((a,b) => b[1] - a[1]) // Maior valor primeiro
                .slice(0, 5) // Top 5
                .forEach(([nome, val]) => {
                    rankingDiv.innerHTML += `
                        <div style="display:flex; justify-content:space-between; padding: 12px 0; border-bottom: 1px solid #333;">
                            <span>${nome}</span>
                            <span style="color: var(--success); font-weight:bold;">R$ ${val.toFixed(2)}</span>
                        </div>
                    `;
                });
        };

        // --- AÇÕES DO USUÁRIO ---
        document.getElementById('formAdd').addEventListener('submit', async (e) => {
            e.preventDefault();
            mostrarLoading(true);
            const novo = {
                data: document.getElementById('inpData').value,
                cliente: document.getElementById('inpCli').value,
                local: document.getElementById('inpLocal').value,
                tipo: document.getElementById('inpServ').value,
                valor: document.getElementById('inpVal').value, // Salva como string bruta, limpamos na leitura
                status: 'Pendente',
                usuario: usuarioAtual
            };
            await addDoc(colRef, novo);
            document.getElementById('formAdd').reset();
            await carregarDados(); // Recarrega tudo para garantir consistência
        });

        window.alterarStatus = async (id, statusAtual) => {
            mostrarLoading(true);
            const novoStatus = statusAtual === 'Pago' ? 'Pendente' : 'Pago';
            await updateDoc(doc(db, "servicos", id), { status: novoStatus });
            await carregarDados();
        };

        window.deletar = async (id) => {
            if(confirm("Deseja realmente excluir este registro?")) {
                mostrarLoading(true);
                await deleteDoc(doc(db, "servicos", id));
                await carregarDados();
            }
        };

        // --- NAVEGAÇÃO ---
        window.navegar = (destino) => {
            // Atualiza Menu
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');

            if (destino === 'stats') {
                viewAtual = 'stats';
                document.getElementById('view-lista').style.display = 'none';
                document.getElementById('view-stats').classList.add('active');
                // Sincroniza o select com o ano que estava sendo visto
                document.getElementById('filtroAnoStat').value = anoSelecionado;
                atualizarStats();
            } else {
                viewAtual = 'lista';
                anoSelecionado = destino;
                document.getElementById('view-stats').classList.remove('active');
                atualizarListaESumario();
            }
        };

        function mostrarLoading(show) {
            document.getElementById('loader').style.display = show ? 'flex' : 'none';
        }
    </script>
</body>
</html>
