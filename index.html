<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insect Control Tupí | Sistema de Gestão</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #D32F2F; --primary-dark: #b71c1c;
            --bg-body: #121212; --bg-card: #1E1E1E; --bg-input: #2C2C2C;
            --text-main: #E0E0E0; --text-muted: #A0A0A0;
            --success: #4CAF50; --warning: #FFC107; --danger: #FF5252;
            --sidebar-width: 260px;
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        .sidebar { width: var(--sidebar-width); background: linear-gradient(180deg, var(--primary-dark) 0%, var(--primary) 100%); display: flex; flex-direction: column; padding: 20px; box-shadow: 4px 0 15px rgba(0,0,0,0.4); z-index: 10; }
        .brand { text-align: center; margin-bottom: 40px; }
        .brand img { width: 80px; height: 80px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.2); padding: 4px; background: white; object-fit: contain; }
        .brand h2 { font-size: 16px; margin-top: 15px; font-weight: 700; color: white; text-transform: uppercase; }

        .menu-item { padding: 14px 18px; border-radius: 8px; color: rgba(255,255,255,0.7); cursor: pointer; transition: all 0.3s; display: flex; align-items: center; margin-bottom: 5px; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.15); color: white; transform: translateX(5px); }

        .main { flex: 1; padding: 30px 40px; overflow-y: auto; }
        .header-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: var(--bg-card); padding: 25px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); border-bottom: 4px solid transparent; }
        .kpi-title { font-size: 12px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 10px; font-weight: 600; }
        .kpi-value { font-size: 28px; font-weight: 700; color: white; }
        .kpi-card.blue { border-color: #2196F3; } .kpi-card.green { border-color: var(--success); } .kpi-card.yellow { border-color: var(--warning); }

        .action-panel { background: var(--bg-card); padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #333; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end; }
        input, select { width: 100%; background: var(--bg-input); border: 1px solid #444; color: white; padding: 12px; border-radius: 6px; }
        .btn-add { background: var(--success); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; height: 42px; }

        .table-container { background: var(--bg-card); border-radius: 8px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        table { width: 100%; border-collapse: collapse; }
        th { background: #252525; color: var(--text-muted); font-size: 12px; text-transform: uppercase; padding: 18px; text-align: left; }
        td { padding: 16px 18px; border-bottom: 1px solid #2C2C2C; font-size: 14px; }
        
        .badge { padding: 6px 12px; border-radius: 50px; font-size: 11px; font-weight: 700; cursor: pointer; text-transform: uppercase; }
        .badge.pago { background: rgba(76, 175, 80, 0.2); color: #81c784; border: 1px solid #2e7d32; }
        .badge.pendente { background: rgba(255, 193, 7, 0.15); color: #ffd54f; border: 1px solid #ff8f00; }
        
        .loader-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(18,18,18,0.9); display: none; justify-content: center; align-items: center; z-index: 50; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .modal-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: var(--bg-card); padding: 40px; border-radius: 12px; width: 320px; text-align: center; border-top: 4px solid var(--primary); }
    </style>
</head>
<body>

    <div id="loginModal" class="modal-wrap">
        <div class="login-box">
            <div class="brand" style="margin-bottom: 20px;"><img src="logo.png.JPG" alt="Insect"></div>
            <h2 style="color:white; margin-top:0;">Acesso Restrito</h2>
            <input type="email" id="email" placeholder="Email" style="margin-bottom: 10px;">
            <input type="password" id="senha" placeholder="Senha" style="margin-bottom: 15px;">
            <button onclick="fazerLogin()" class="btn-add" style="width:100%">ENTRAR</button>
        </div>
    </div>

    <div id="app" style="display: none; width: 100%; height: 100%;">
        <nav class="sidebar">
            <div class="brand">
                <img src="logo.png.JPG" alt="Logo">
                <h2>Insect Control<br>Tupí</h2>
            </div>
            <a class="menu-item active" onclick="navegar('2026')"><i class="fas fa-calendar-alt" style="margin-right:10px"></i> Serviços 2026</a>
            <a class="menu-item" onclick="navegar('2025')"><i class="fas fa-history" style="margin-right:10px"></i> Serviços 2025</a>
            <a class="menu-item" onclick="navegar('stats')"><i class="fas fa-chart-line" style="margin-right:10px"></i> Estatísticas</a>
            <div style="margin-top: auto;"><a class="menu-item" onclick="sair()"><i class="fas fa-sign-out-alt" style="margin-right:10px"></i> Sair</a></div>
        </nav>

        <main class="main">
            <div id="loader" class="loader-overlay"><div class="spinner"></div><p style="margin-top:15px">Processando dados...</p></div>

            <div id="view-lista" style="display:block;">
                <div class="header-title">
                    <h1 id="tituloPagina">Painel 2026</h1>
                </div>
                <div class="kpi-grid">
                    <div class="kpi-card blue"><div class="kpi-title">Total Ordens</div><div class="kpi-value" id="kpiQtd">0</div></div>
                    <div class="kpi-card green"><div class="kpi-title">Faturamento Pago</div><div class="kpi-value" id="kpiFat">R$ 0,00</div></div>
                    <div class="kpi-card yellow"><div class="kpi-title">Aguardando</div><div class="kpi-value" id="kpiPend">R$ 0,00</div></div>
                </div>
                <div class="action-panel">
                    <form id="formAdd" class="form-row">
                        <input type="date" id="inpData" required>
                        <input type="text" id="inpCli" placeholder="Cliente" required>
                        <input type="text" id="inpLocal" placeholder="Local" required>
                        <input type="text" id="inpServ" placeholder="Serviço" required>
                        <input type="text" id="inpVal" placeholder="Valor (Ex: 150,00)" required>
                        <button type="submit" class="btn-add">LANÇAR</button>
                    </form>
                </div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Data</th><th>Cliente</th><th>Serviço</th><th>Valor</th><th>Status</th><th>Ação</th></tr></thead>
                        <tbody id="tabelaCorpo"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-stats" style="display:none;">
                <div class="header-title">
                    <h1>Análise Financeira</h1>
                    <select id="filtroAnoStat" onchange="atualizarStats()" style="width:150px; background:#333; color:white; border:none;">
                        <option value="2026">2026</option>
                        <option value="2025">2025</option>
                    </select>
                </div>
                <div class="kpi-grid">
                    <div class="kpi-card"><div class="kpi-title">Ticket Médio</div><div class="kpi-value" id="statTicket">R$ 0,00</div></div>
                    <div class="kpi-card green"><div class="kpi-title">Conversão (Pago)</div><div class="kpi-value" id="statPerc">0%</div></div>
                </div>
                <div class="action-panel">
                    <h3 style="color:var(--text-muted); font-size:12px; text-transform:uppercase;">Maiores Clientes</h3>
                    <div id="rankingClientes"></div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, query, where, updateDoc } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

        const app = initializeApp({
            apiKey: "AIzaSyCIU7yiuI1uXfJWv6MoGYTv6ylqhzQhscA",
            authDomain: "insectcontrol-54785.firebaseapp.com",
            projectId: "insectcontrol-54785",
            storageBucket: "insectcontrol-54785.appspot.com",
            messagingSenderId: "299720867487",
            appId: "1:299720867487:web:cdcff964efc45755496caa"
        });

        const auth = getAuth(app);
        const db = getFirestore(app);
        const colRef = collection(db, "servicos");

        let dadosBrutos = [];
        let dadosProcessados = [];
        let usuarioEmail = null;
        let anoAtual = "2026";
        let telaAtual = "lista";

        // --- FUNÇÕES DE LIMPEZA PESADA (O SEGREDO) ---
        function limparValor(valor) {
            if (!valor) return 0;
            let str = String(valor);
            
            // Se já for número, retorna
            if (typeof valor === 'number') return valor;

            // Remove R$, espaços e caracteres estranhos
            // Mantém apenas números, vírgula e ponto
            str = str.replace(/[^\d.,]/g, '');

            // Lógica para Brasil: "1.200,50" -> Remove ponto de milhar, troca vírgula por ponto
            if (str.includes(',') && str.includes('.')) {
                str = str.replace(/\./g, '').replace(',', '.'); 
            } else if (str.includes(',')) {
                str = str.replace(',', '.');
            }
            
            return parseFloat(str) || 0;
        }

        function descobrirAno(dataStr) {
            if (!dataStr) return "Desconhecido";
            // Procura "2024", "2025", "2026" em qualquer lugar da string
            const match = String(dataStr).match(/202[0-9]/);
            return match ? match[0] : "Desconhecido";
        }

        // --- AUTENTICAÇÃO ---
        window.fazerLogin = () => {
            const e = document.getElementById('email').value;
            const s = document.getElementById('senha').value;
            signInWithEmailAndPassword(auth, e, s).catch(err => alert("Erro: " + err.message));
        };
        window.sair = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                usuarioEmail = user.email;
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                carregarDadosDoFirebase();
            } else {
                document.getElementById('app').style.display = 'none';
                document.getElementById('loginModal').style.display = 'flex';
            }
        });

        // --- LÓGICA DE DADOS ---
        async function carregarDadosDoFirebase() {
            mostrarLoading(true);
            try {
                const q = query(colRef, where("usuario", "==", usuarioEmail));
                const snap = await getDocs(q);
                
                dadosBrutos = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Processamento Unificado (Converte tudo antes de usar)
                dadosProcessados = dadosBrutos.map(item => {
                    return {
                        ...item,
                        valorReal: limparValor(item.valor),
                        anoReal: descobrirAno(item.data),
                        statusReal: item.status ? item.status.trim() : 'Pendente' // Remove espaços extras
                    };
                });

                console.log("Dados Carregados:", dadosProcessados); // Para depuração se precisar
                renderizarTela();
            } catch (e) {
                console.error(e);
            } finally {
                mostrarLoading(false);
            }
        }

        function renderizarTela() {
            if (telaAtual === 'stats') {
                atualizarStats();
            } else {
                renderizarLista();
            }
        }

        function renderizarLista() {
            document.getElementById('view-lista').style.display = 'block';
            document.getElementById('view-stats').style.display = 'none';
            document.getElementById('tituloPagina').innerText = `Painel ${anoAtual}`;

            const tbody = document.getElementById('tabelaCorpo');
            tbody.innerHTML = '';

            const listaFiltrada = dadosProcessados.filter(d => d.anoReal === anoAtual);
            
            // Ordenação (Tenta converter data para ordenar, senão usa string)
            listaFiltrada.sort((a, b) => {
                const da = new Date(a.data.split('/').reverse().join('-'));
                const db = new Date(b.data.split('/').reverse().join('-'));
                return db - da; 
            });

            let qtd = 0, fat = 0, pend = 0;

            listaFiltrada.forEach(item => {
                qtd++;
                if (item.statusReal === 'Pago') fat += item.valorReal;
                else pend += item.valorReal;

                // Formatar Data para Exibir
                let dataExib = item.data;
                if(dataExib.includes('-')) dataExib = dataExib.split('-').reverse().join('/');

                tbody.innerHTML += `
                    <tr>
                        <td>${dataExib}</td>
                        <td><b>${item.cliente.toUpperCase()}</b></td>
                        <td>${item.tipo}</td>
                        <td>R$ ${item.valorReal.toFixed(2)}</td>
                        <td><span class="badge ${item.statusReal === 'Pago' ? 'pago' : 'pendente'}" onclick="window.trocarStatus('${item.id}', '${item.statusReal}')">${item.statusReal}</span></td>
                        <td><button onclick="window.apagar('${item.id}')" style="background:none;border:none;color:#555;cursor:pointer;"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `;
            });

            document.getElementById('kpiQtd').innerText = qtd;
            document.getElementById('kpiFat').innerText = `R$ ${fat.toFixed(2)}`;
            document.getElementById('kpiPend').innerText = `R$ ${pend.toFixed(2)}`;
        }

        window.atualizarStats = () => {
            const anoSel = document.getElementById('filtroAnoStat').value;
            const dadosAno = dadosProcessados.filter(d => d.anoReal === anoSel);

            let fat = 0, rec = 0;
            const clientes = {};

            dadosAno.forEach(d => {
                fat += d.valorReal;
                if(d.statusReal === 'Pago') rec += d.valorReal;
                
                const nome = d.cliente.trim().toUpperCase();
                clientes[nome] = (clientes[nome] || 0) + d.valorReal;
            });

            // KPIs
            const ticket = dadosAno.length ? (fat / dadosAno.length) : 0;
            const conv = fat > 0 ? (rec / fat) * 100 : 0;

            document.getElementById('statTicket').innerText = `R$ ${ticket.toFixed(2)}`;
            document.getElementById('statPerc').innerText = conv.toFixed(1) + '%';

            // Top Clientes
            const listaCli = document.getElementById('rankingClientes');
            listaCli.innerHTML = '';
            
            Object.entries(clientes).sort((a,b) => b[1] - a[1]).slice(0,5).forEach(([nome, val]) => {
                listaCli.innerHTML += `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #333; font-size:13px;">
                    <span>${nome}</span><span style="color:var(--success)">R$ ${val.toFixed(2)}</span>
                </div>`;
            });
        };

        // --- AÇÕES ---
        document.getElementById('formAdd').addEventListener('submit', async (e) => {
            e.preventDefault();
            mostrarLoading(true);
            await addDoc(colRef, {
                data: document.getElementById('inpData').value,
                cliente: document.getElementById('inpCli').value,
                local: document.getElementById('inpLocal').value,
                tipo: document.getElementById('inpServ').value,
                valor: document.getElementById('inpVal').value, // Salva cru, limpamos na leitura
                status: 'Pendente',
                usuario: usuarioEmail
            });
            document.getElementById('formAdd').reset();
            carregarDadosDoFirebase();
        });

        window.trocarStatus = async (id, stAtual) => {
            mostrarLoading(true);
            await updateDoc(doc(db, "servicos", id), { status: stAtual === 'Pago' ? 'Pendente' : 'Pago' });
            carregarDadosDoFirebase();
        };

        window.apagar = async (id) => {
            if(confirm("Confirmar exclusão?")) {
                mostrarLoading(true);
                await deleteDoc(doc(db, "servicos", id));
                carregarDadosDoFirebase();
            }
        };

        window.navegar = (destino) => {
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            event.currentTarget.classList.add('active');

            if(destino === 'stats') {
                telaAtual = 'stats';
                document.getElementById('view-lista').style.display = 'none';
                document.getElementById('view-stats').style.display = 'block';
                document.getElementById('filtroAnoStat').value = anoAtual;
                atualizarStats();
            } else {
                telaAtual = 'lista';
                anoAtual = destino;
                document.getElementById('view-stats').style.display = 'none';
                document.getElementById('view-lista').style.display = 'block';
                renderizarLista();
            }
        };

        function mostrarLoading(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }
    </script>
</body>
</html>
