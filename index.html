<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INSECT TUPÍ | Enterprise Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --brand-primary: #FF0000;
            --brand-secondary: #2D3436;
            --accent: #00CEC9;
            --bg-dark: #0F1113;
            --card-bg: rgba(30, 33, 37, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #FFFFFF;
            --text-dim: #A0AEC0;
            --success: #00B894;
            --warning: #FDCB6E;
            --sidebar-width: 280px;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            margin: 0; 
            background: radial-gradient(circle at top right, #1a1c20, #0f1113);
            color: var(--text-main);
            min-height: 100vh;
        }

        /* Layout Estrutural */
        .app-container { display: grid; grid-template-columns: var(--sidebar-width) 1fr; min-height: 100vh; }

        /* Sidebar Luxury */
        .sidebar {
            background: #000;
            padding: 40px 24px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--glass-border);
        }

        .brand { text-align: center; margin-bottom: 50px; }
        .brand img { width: 80px; filter: drop-shadow(0 0 15px rgba(255,0,0,0.4)); border-radius: 50%; border: 2px solid var(--brand-primary); }
        .brand h2 { font-size: 18px; letter-spacing: 2px; margin-top: 15px; color: var(--brand-primary); }

        .nav-menu { flex-grow: 1; }
        .nav-item {
            display: flex; align-items: center; padding: 14px 18px; margin-bottom: 10px;
            color: var(--text-dim); text-decoration: none; border-radius: 12px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer;
        }
        .nav-item i { font-size: 20px; margin-right: 15px; }
        .nav-item:hover, .nav-item.active { 
            background: var(--brand-primary); color: white; 
            box-shadow: 0 10px 20px rgba(255, 0, 0, 0.2);
        }

        /* Área de Trabalho */
        .workspace { padding: 40px; max-width: 1400px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        
        /* Dashboard Cards Aero */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .kpi-card {
            background: var(--card-bg); backdrop-filter: blur(10px);
            padding: 25px; border-radius: 20px; border: 1px solid var(--glass-border);
            position: relative; overflow: hidden;
        }
        .kpi-card::after {
            content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.03), transparent);
            transform: rotate(45deg); pointer-events: none;
        }
        .kpi-card h4 { margin: 0; font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
        .kpi-card .val { font-size: 32px; font-weight: 700; margin: 10px 0; display: block; }
        
        /* Tabela Profissional */
        .glass-panel {
            background: var(--card-bg); backdrop-filter: blur(15px);
            border-radius: 24px; border: 1px solid var(--glass-border);
            padding: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .search-box {
            background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
            padding: 12px 20px; border-radius: 12px; color: white; width: 300px; outline: none;
        }

        .main-table { width: 100%; border-collapse: collapse; }
        .main-table th { text-align: left; padding: 20px; color: var(--brand-primary); font-size: 12px; text-transform: uppercase; border-bottom: 1px solid #333; }
        .main-table td { padding: 18px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 14px; }
        .main-table tr:hover { background: rgba(255,255,255,0.02); }

        /* Badges de Status Modernas */
        .badge { padding: 6px 14px; border-radius: 8px; font-size: 11px; font-weight: 700; cursor: pointer; text-transform: uppercase; }
        .badge-paid { background: rgba(0, 184, 148, 0.15); color: var(--success); border: 1px solid var(--success); }
        .badge-pending { background: rgba(253, 203, 110, 0.15); color: var(--warning); border: 1px solid var(--warning); }

        /* Formulário Flutuante */
        .form-drawer {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;
            background: rgba(255,255,255,0.03); padding: 20px; border-radius: 15px; margin-bottom: 30px;
        }
        .form-drawer input {
            background: #000; border: 1px solid var(--glass-border); padding: 14px;
            border-radius: 10px; color: white; font-family: inherit;
        }
        .btn-add {
            background: var(--brand-primary); color: white; border: none;
            border-radius: 10px; font-weight: 700; cursor: pointer; transition: 0.3s;
        }
        .btn-add:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(255,0,0,0.4); }

        /* Stats Grid Extra */
        .stats-row { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-top: 30px; }
        .chart-box { background: var(--card-bg); padding: 25px; border-radius: 20px; border: 1px solid var(--glass-border); }

        /* Recibo de Impressão */
        @media print {
            .sidebar, .form-drawer, .search-box, .btn-action, .kpi-grid { display: none !important; }
            .glass-panel { border: none; background: white; color: black; }
            .main-table th { color: black; }
        }

        /* Animações */
        .view-content { display: none; animation: slideUp 0.5s ease; }
        .view-content.active { display: block; }
        @keyframes slideUp { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="loginSection" class="modal" style="display: flex; position:fixed; width:100%; height:100%; background:#000; z-index:9999; justify-content:center; align-items:center;">
        <div style="background:#111; padding:50px; border-radius:30px; border:1px solid #333; width:100%; max-width:350px; text-align:center;">
            <img src="logo.png.JPG" style="width:80px; margin-bottom:20px;">
            <h2 style="margin-bottom:30px;">INSECT TUPÍ <span style="font-weight:300; color:#666;">CONTROL</span></h2>
            <input type="email" id="email" placeholder="Email corporativo" style="width:100%; padding:15px; margin-bottom:15px; border-radius:10px; border:1px solid #333; background:#000; color:white;">
            <input type="password" id="senha" placeholder="Senha" style="width:100%; padding:15px; margin-bottom:25px; border-radius:10px; border:1px solid #333; background:#000; color:white;">
            <button onclick="window.login()" style="width:100%; padding:15px; border-radius:10px; border:none; background:red; color:white; font-weight:bold; cursor:pointer;">ACESSAR PAINEL</button>
            <p onclick="window.showCadastro()" style="margin-top:20px; color:#555; cursor:pointer; font-size:12px;">Primeiro acesso? Criar conta</p>
        </div>
    </div>

    <div class="app-container" id="mainApp" style="display:none;">
        <aside class="sidebar">
            <div class="brand">
                <img src="logo.png.JPG" alt="Insect Tupi">
                <h2>INSECT TUPÍ</h2>
            </div>
            
            <nav class="nav-menu">
                <div class="nav-item active" data-view="2026">
                    <i class="fa-solid fa-rocket"></i> <span>Temporada 2026</span>
                </div>
                <div class="nav-item" data-view="2025">
                    <i class="fa-solid fa-box-archive"></i> <span>Histórico 2025</span>
                </div>
                <div class="nav-item" data-view="stats">
                    <i class="fa-solid fa-chart-line"></i> <span>Business Analytics</span>
                </div>
            </nav>

            <div class="nav-item" onclick="window.logout()" style="margin-top: auto; color: #ff4757;">
                <i class="fa-solid fa-arrow-right-from-bracket"></i> <span>Encerrar Sessão</span>
            </div>
        </aside>

        <main class="workspace">
            
            <div id="view-servicos" class="view-content active">
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <h4>Receita Confirmada</h4>
                        <span class="val" id="kpiRecebido" style="color: var(--success);">R$ 0,00</span>
                        <div style="font-size: 11px; color: var(--text-dim);">Pagamentos liquidados este ano</div>
                    </div>
                    <div class="kpi-card" style="border-bottom: 4px solid var(--warning);">
                        <h4>Contas a Receber</h4>
                        <span class="val" id="kpiPendente" style="color: var(--warning);">R$ 0,00</span>
                        <div style="font-size: 11px; color: var(--text-dim);">Serviços pendentes de cobrança</div>
                    </div>
                    <div class="kpi-card">
                        <h4>Ticket Médio</h4>
                        <span class="val" id="kpiTicket" style="color: var(--accent);">R$ 0,00</span>
                        <div style="font-size: 11px; color: var(--text-dim);">Valor médio por contrato</div>
                    </div>
                </div>

                <div class="glass-panel">
                    <div class="table-header">
                        <h2 id="headerTitulo" style="margin:0;">Lançamentos 2026</h2>
                        <input type="text" id="mainSearch" class="search-box" placeholder="Filtrar por cliente, bairro ou serviço...">
                    </div>

                    <form id="formAdd" class="form-drawer">
                        <input type="date" id="data" required>
                        <input type="text" id="cliente" placeholder="Nome do Cliente" required>
                        <input type="text" id="local" placeholder="Localidade" required>
                        <input type="text" id="tipo" placeholder="Tipo de Serviço" required>
                        <input type="number" id="valor" placeholder="Valor R$" step="0.01" required>
                        <button type="submit" class="btn-add">REGISTRAR</button>
                    </form>

                    <div style="overflow-x: auto;">
                        <table class="main-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Cliente</th>
                                    <th>Localização</th>
                                    <th>Serviço Prestado</th>
                                    <th>Valor</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="dataGrid"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-stats" class="view-content">
                <h1 style="margin-bottom: 30px;">Performance Operacional</h1>
                
                <div class="stats-row">
                    <div class="chart-box">
                        <h3><i class="fa-solid fa-trophy" style="color:gold"></i> Top Clientes High-Value</h3>
                        <div id="listTopClientes" style="margin-top:20px;"></div>
                    </div>
                    <div class="chart-box">
                        <h3><i class="fa-solid fa-bullseye" style="color:red"></i> Conversão de Pagos</h3>
                        <div style="text-align:center; padding: 40px 0;">
                            <span id="percPago" style="font-size: 50px; font-weight:800; color: var(--success);">0%</span>
                            <p style="color: var(--text-dim);">da receita total recebida</p>
                        </div>
                    </div>
                </div>

                <div class="glass-panel" style="margin-top:30px;">
                    <h3><i class="fa-solid fa-layer-group"></i> Sazonalidade e Demanda de Serviços</h3>
                    <div id="listServicosFrequentes" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top:20px;"></div>
                </div>
            </div>

        </main>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, query, where, updateDoc } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCIU7yiuI1uXfJWv6MoGYTv6ylqhzQhscA",
            authDomain: "insectcontrol-54785.firebaseapp.com",
            projectId: "insectcontrol-54785",
            storageBucket: "insectcontrol-54785.appspot.com",
            messagingSenderId: "299720867487",
            appId: "1:299720867487:web:cdcff964efc45755496caa"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let dbCache = [];
        let currentYear = "2026";

        // --- CONTROLE DE TELAS ---
        document.querySelectorAll('.nav-item').forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.dataset.view;
                if(!target) return;

                document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.view-content').forEach(v => v.classList.remove('active'));
                
                btn.classList.add('active');
                
                if(target === 'stats') {
                    document.getElementById('view-stats').classList.add('active');
                    buildAnalytics();
                } else {
                    currentYear = target;
                    document.getElementById('view-servicos').classList.add('active');
                    document.getElementById('headerTitulo').innerText = `Lançamentos ${currentYear}`;
                    renderTable();
                }
            });
        });

        // --- AUTH ---
        onAuthStateChanged(auth, user => {
            if(user) {
                currentUser = user.email;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('mainApp').style.display = 'grid';
                loadData();
            } else {
                document.getElementById('loginSection').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
            }
        });

        window.login = () => {
            const e = document.getElementById('email').value;
            const s = document.getElementById('senha').value;
            signInWithEmailAndPassword(auth, e, s).catch(() => alert("Acesso Negado."));
        };
        window.logout = () => signOut(auth);

        // --- CORE DATA ---
        async function loadData() {
            const q = query(collection(db, "servicos"), where("usuario", "==", currentUser));
            const snap = await getDocs(q);
            dbCache = snap.docs.map(d => ({id: d.id, ...d.data()}));
            renderTable();
        }

        document.getElementById('formAdd').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                data: document.getElementById('data').value,
                cliente: document.getElementById('cliente').value,
                local: document.getElementById('local').value,
                tipo: document.getElementById('tipo').value,
                valor: document.getElementById('valor').value,
                status: 'Pendente',
                usuario: currentUser
            };
            await addDoc(collection(db, "servicos"), data);
            document.getElementById('formAdd').reset();
            loadData();
        });

        window.togglePay = async (id, current) => {
            await updateDoc(doc(db, "servicos", id), { status: current === 'Pago' ? 'Pendente' : 'Pago' });
            loadData();
        };

        window.removeJob = async (id) => {
            if(confirm("Confirmar deleção do registro?")) {
                await deleteDoc(doc(db, "servicos", id));
                loadData();
            }
        };

        // --- UI RENDERING ---
        function renderTable() {
            const grid = document.getElementById('dataGrid');
            const search = document.getElementById('mainSearch').value.toLowerCase();
            grid.innerHTML = '';
            
            let rec = 0, pen = 0, count = 0;

            const filtered = dbCache.filter(s => {
                const matchYear = s.data.startsWith(currentYear);
                const matchSearch = s.cliente.toLowerCase().includes(search) || s.tipo.toLowerCase().includes(search) || s.local.toLowerCase().includes(search);
                return matchYear && matchSearch;
            }).sort((a,b) => new Date(b.data) - new Date(a.data));

            filtered.forEach(s => {
                const val = parseFloat(s.valor) || 0;
                count++;
                if(s.status === 'Pago') rec += val; else pen += val;

                grid.innerHTML += `
                    <tr>
                        <td>${s.data.split('-').reverse().join('/')}</td>
                        <td style="font-weight:600;">${s.cliente}</td>
                        <td><i class="fa-solid fa-location-dot" style="color:#555"></i> ${s.local}</td>
                        <td><span style="background:rgba(255,255,255,0.05); padding:5px 10px; border-radius:6px;">${s.tipo}</span></td>
                        <td style="font-weight:700;">R$ ${val.toFixed(2)}</td>
                        <td><span class="badge ${s.status === 'Pago' ? 'badge-paid' : 'badge-pending'}" onclick="window.togglePay('${s.id}', '${s.status}')">${s.status}</span></td>
                        <td>
                            <button class="btn-action" onclick="window.removeJob('${s.id}')" style="background:none; border:none; color:#444; cursor:pointer;"><i class="fa-solid fa-trash-can"></i></button>
                            <button onclick="window.printRecibo('${s.id}')" style="background:none; border:none; color:#444; cursor:pointer; margin-left:10px;"><i class="fa-solid fa-print"></i></button>
                        </td>
                    </tr>
                `;
            });

            document.getElementById('kpiRecebido').innerText = `R$ ${rec.toFixed(2)}`;
            document.getElementById('kpiPendente').innerText = `R$ ${pen.toFixed(2)}`;
            document.getElementById('kpiTicket').innerText = count > 0 ? `R$ ${(rec/count).toFixed(2)}` : 'R$ 0,00';
        }

        document.getElementById('mainSearch').addEventListener('input', renderTable);

        // --- ANALYTICS ENGINE ---
        function buildAnalytics() {
            const topCList = document.getElementById('listTopClientes');
            const topSList = document.getElementById('listServicosFrequentes');
            topCList.innerHTML = ''; topSList.innerHTML = '';

            const clientMap = {}, serviceMap = {};
            let totalVal = 0, paidVal = 0;

            dbCache.forEach(s => {
                const v = parseFloat(s.valor) || 0;
                totalVal += v;
                if(s.status === 'Pago') paidVal += v;

                clientMap[s.cliente] = (clientMap[s.cliente] || 0) + v;
                serviceMap[s.tipo] = (serviceMap[s.tipo] || 0) + 1;
            });

            // Top Clientes UI
            Object.entries(clientMap).sort((a,b) => b[1]-a[1]).slice(0,5).forEach(([name, val]) => {
                topCList.innerHTML += `
                    <div style="display:flex; justify-content:space-between; padding:15px; background:rgba(255,255,255,0.02); border-radius:12px; margin-bottom:10px; border:1px solid rgba(255,255,255,0.05);">
                        <span>${name}</span>
                        <span style="color:var(--success); font-weight:700;">R$ ${val.toFixed(2)}</span>
                    </div>
                `;
            });

            // Top Serviços UI
            Object.entries(serviceMap).sort((a,b) => b[1]-a[1]).slice(0,6).forEach(([name, qty]) => {
                topSList.innerHTML += `
                    <div style="padding:20px; background:#000; border-radius:15px; border:1px solid #333; text-align:center;">
                        <div style="font-size:24px; font-weight:800; color:var(--brand-primary);">${qty}x</div>
                        <div style="font-size:12px; color:var(--text-dim); margin-top:5px; text-transform:uppercase;">${name}</div>
                    </div>
                `;
            });

            const perc = totalVal > 0 ? (paidVal / totalVal) * 100 : 0;
            document.getElementById('percPago').innerText = Math.round(perc) + '%';
        }

        window.printRecibo = (id) => {
            const s = dbCache.find(x => x.id === id);
            const win = window.open('', 'PRINT', 'height=600,width=800');
            win.document.write(`
                <html><body style="font-family:sans-serif; padding:40px;">
                    <h1 style="color:red">RECIBO DE PRESTAÇÃO DE SERVIÇO</h1>
                    <hr>
                    <p><b>CLIENTE:</b> ${s.cliente}</p>
                    <p><b>DATA:</b> ${s.data}</p>
                    <p><b>SERVIÇO:</b> ${s.tipo}</p>
                    <p><b>LOCAL:</b> ${s.local}</p>
                    <h2 style="background:#eee; padding:20px;">VALOR: R$ ${parseFloat(s.valor).toFixed(2)}</h2>
                    <br><br><p>___________________________________</p><p>Assinatura Insect Tupí</p>
                </body></html>
            `);
            win.document.close();
            win.print();
        };

    </script>
</body>
</html>
