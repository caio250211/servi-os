<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INSECT CONTROL TUPÍ | Enterprise Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --brand-primary: #FF0000;
            --brand-secondary: #2D3436;
            --accent: #00CEC9;
            --bg-dark: #0F1113;
            --card-bg: rgba(30, 33, 37, 0.8);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #FFFFFF;
            --text-dim: #A0AEC0;
            --success: #00B894;
            --warning: #FDCB6E;
            --sidebar-width: 280px;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            margin: 0; 
            background: radial-gradient(circle at top right, #1a1c20, #0f1113);
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container { display: grid; grid-template-columns: var(--sidebar-width) 1fr; min-height: 100vh; }

        /* SIDEBAR */
        .sidebar {
            background: #000;
            padding: 40px 24px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--glass-border);
            position: sticky;
            top: 0;
            height: 100vh;
        }

        .brand { text-align: center; margin-bottom: 50px; }
        .brand img { width: 80px; filter: drop-shadow(0 0 15px rgba(255,0,0,0.4)); border-radius: 50%; border: 2px solid var(--brand-primary); }
        .brand h2 { font-size: 18px; letter-spacing: 2px; margin-top: 15px; color: var(--brand-primary); }

        .nav-menu { flex-grow: 1; }
        .nav-item {
            display: flex; align-items: center; padding: 14px 18px; margin-bottom: 10px;
            color: var(--text-dim); text-decoration: none; border-radius: 12px;
            transition: all 0.3s ease; cursor: pointer;
        }
        .nav-item i { font-size: 20px; margin-right: 15px; width: 25px; text-align: center; }
        .nav-item:hover, .nav-item.active { 
            background: var(--brand-primary); color: white; 
            box-shadow: 0 10px 20px rgba(255, 0, 0, 0.2);
        }

        /* CONTEÚDO */
        .workspace { padding: 40px; max-width: 1400px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card {
            background: var(--card-bg); backdrop-filter: blur(10px);
            padding: 25px; border-radius: 20px; border: 1px solid var(--glass-border);
        }
        .kpi-card h4 { margin: 0; font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
        .kpi-card .val { font-size: 28px; font-weight: 700; margin: 10px 0; display: block; }
        
        .glass-panel {
            background: var(--card-bg); backdrop-filter: blur(15px);
            border-radius: 20px; border: 1px solid var(--glass-border);
            padding: 25px; box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }

        .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
        .search-box {
            background: rgba(0,0,0,0.4); border: 1px solid var(--glass-border);
            padding: 12px 20px; border-radius: 12px; color: white; width: 300px; outline: none;
        }

        .main-table { width: 100%; border-collapse: collapse; }
        .main-table th { text-align: left; padding: 15px; color: var(--brand-primary); font-size: 11px; text-transform: uppercase; border-bottom: 1px solid #333; }
        .main-table td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 14px; }

        .badge { padding: 6px 12px; border-radius: 6px; font-size: 10px; font-weight: 800; cursor: pointer; text-transform: uppercase; border: 1px solid transparent; }
        .badge-paid { background: rgba(0, 184, 148, 0.1); color: var(--success); border-color: var(--success); }
        .badge-pending { background: rgba(253, 203, 110, 0.1); color: var(--warning); border-color: var(--warning); }

        .form-drawer {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;
            background: rgba(255,255,255,0.02); padding: 20px; border-radius: 15px; margin-bottom: 25px;
        }
        .form-drawer input {
            background: #000; border: 1px solid var(--glass-border); padding: 12px;
            border-radius: 8px; color: white; outline: none;
        }
        .btn-add { background: var(--brand-primary); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; }

        /* STATS */
        .stats-row { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; margin-top: 20px; }
        .chart-box { background: var(--card-bg); padding: 20px; border-radius: 20px; border: 1px solid var(--glass-border); }

        /* AUTH */
        .auth-screen { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .auth-card { background: #111; padding: 40px; border-radius: 25px; border: 1px solid #222; width: 100%; max-width: 340px; text-align: center; }
        
        .view-content { display: none; }
        .view-content.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        @media (max-width: 1024px) {
            .app-container { grid-template-columns: 1fr; }
            .sidebar { height: auto; position: relative; width: 100%; padding: 20px; flex-direction: row; flex-wrap: wrap; }
            .brand { width: 100%; margin-bottom: 20px; }
            .nav-menu { display: flex; gap: 10px; width: 100%; overflow-x: auto; padding-bottom: 10px; }
            .nav-item { margin-bottom: 0; white-space: nowrap; }
        }
    </style>
</head>
<body>

    <div id="authSection" class="auth-screen">
        <div class="auth-card">
            <img src="logo.png.JPG" style="width: 70px; margin-bottom: 15px;">
            <h2 style="color: var(--brand-primary); margin-bottom: 5px;">INSECT TUPÍ</h2>
            <p style="color: #555; font-size: 13px; margin-bottom: 30px;">BUSINESS MANAGEMENT</p>
            <input type="email" id="email" placeholder="Email" style="width:100%; padding:14px; margin-bottom:10px; border-radius:10px; border:1px solid #333; background:#000; color:white;">
            <input type="password" id="password" placeholder="Senha" style="width:100%; padding:14px; margin-bottom:20px; border-radius:10px; border:1px solid #333; background:#000; color:white;">
            <button onclick="window.handleAuth()" style="width:100%; padding:14px; border-radius:10px; border:none; background:red; color:white; font-weight:bold; cursor:pointer;">ENTRAR NO PAINEL</button>
        </div>
    </div>

    <div class="app-container" id="appMain" style="display:none;">
        <aside class="sidebar">
            <div class="brand">
                <img src="logo.png.JPG" alt="Insect Tupi">
                <h2>INSECT TUPÍ</h2>
            </div>
            <nav class="nav-menu">
                <div class="nav-item active" data-view="2026"><i class="fa-solid fa-calendar-day"></i><span>Serviços 2026</span></div>
                <div class="nav-item" data-view="2025"><i class="fa-solid fa-clock-rotate-left"></i><span>Histórico 2025</span></div>
                <div class="nav-item" data-view="stats"><i class="fa-solid fa-chart-pie"></i><span>Estatísticas</span></div>
            </nav>
            <div class="nav-item" onclick="window.logout()" style="color: #ff4757;"><i class="fa-solid fa-power-off"></i><span>Sair</span></div>
        </aside>

        <main class="workspace">
            <div id="view-main" class="view-content active">
                <div class="kpi-grid">
                    <div class="kpi-card"><h4>Recebido</h4><span class="val" id="kpiRec" style="color: var(--success);">R$ 0,00</span></div>
                    <div class="kpi-card"><h4>Pendente</h4><span class="val" id="kpiPen" style="color: var(--warning);">R$ 0,00</span></div>
                    <div class="kpi-card"><h4>Ticket Médio</h4><span class="val" id="kpiAvg" style="color: var(--accent);">R$ 0,00</span></div>
                </div>

                <div class="glass-panel">
                    <div class="table-header">
                        <h2 id="viewTitle">Serviços 2026</h2>
                        <input type="text" id="searchInput" class="search-box" placeholder="Pesquisar cliente ou local...">
                    </div>

                    <form id="formAdd" class="form-drawer">
                        <input type="date" id="fDate" required>
                        <input type="text" id="fClient" placeholder="Cliente" required>
                        <input type="text" id="fLocal" placeholder="Local" required>
                        <input type="text" id="fService" placeholder="Serviço" required>
                        <input type="number" id="fValue" placeholder="Valor" step="0.01" required>
                        <button type="submit" class="btn-add">CADASTRAR</button>
                    </form>

                    <div style="overflow-x: auto;">
                        <table class="main-table">
                            <thead>
                                <tr><th>Data</th><th>Cliente</th><th>Localização</th><th>Serviço</th><th>Valor</th><th>Status</th><th>Ações</th></tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-stats" class="view-content">
                <h1>Performance de Negócio</h1>
                <div class="stats-row">
                    <div class="chart-box">
                        <h3 style="color: var(--brand-primary)">Ranking de Clientes</h3>
                        <div id="statsClients"></div>
                    </div>
                    <div class="chart-box">
                        <h3>Conversão Geral</h3>
                        <div style="text-align:center; padding: 30px 0;">
                            <div id="percLabel" style="font-size: 48px; font-weight: 800; color: var(--success);">0%</div>
                            <p style="color: var(--text-dim);">da receita recebida</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, query, where, updateDoc } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCIU7yiuI1uXfJWv6MoGYTv6ylqhzQhscA",
            authDomain: "insectcontrol-54785.firebaseapp.com",
            projectId: "insectcontrol-54785",
            storageBucket: "insectcontrol-54785.appspot.com",
            messagingSenderId: "299720867487",
            appId: "1:299720867487:web:cdcff964efc45755496caa"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userMail = null;
        let localData = [];
        let currentYear = "2026";

        // AUTH HANDLER
        onAuthStateChanged(auth, user => {
            if(user) {
                userMail = user.email;
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('appMain').style.display = 'grid';
                fetchData();
            } else {
                document.getElementById('authSection').style.display = 'flex';
                document.getElementById('appMain').style.display = 'none';
            }
        });

        window.handleAuth = () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, e, p).catch(err => alert("Erro ao acessar."));
        };

        window.logout = () => signOut(auth);

        // DATA HANDLER
        async function fetchData() {
            const q = query(collection(db, "servicos"), where("usuario", "==", userMail));
            const snap = await getDocs(q);
            localData = snap.docs.map(d => ({id: d.id, ...d.data()}));
            renderAll();
        }

        document.getElementById('formAdd').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                data: document.getElementById('fDate').value,
                cliente: document.getElementById('fClient').value,
                local: document.getElementById('fLocal').value,
                tipo: document.getElementById('fService').value,
                valor: document.getElementById('fValue').value,
                status: 'Pendente',
                usuario: userMail
            };
            await addDoc(collection(db, "servicos"), data);
            document.getElementById('formAdd').reset();
            fetchData();
        });

        window.updateStatus = async (id, status) => {
            await updateDoc(doc(db, "servicos", id), { status: status === 'Pago' ? 'Pendente' : 'Pago' });
            fetchData();
        };

        window.deleteItem = async (id) => {
            if(confirm("Excluir definitivamente?")) {
                await deleteDoc(doc(db, "servicos", id));
                fetchData();
            }
        };

        // UI RENDER
        function renderAll() {
            const body = document.getElementById('tableBody');
            const search = document.getElementById('searchInput').value.toLowerCase();
            body.innerHTML = '';

            let r = 0, p = 0, c = 0;

            const filtered = localData.filter(item => {
                // Filtro de ano robusto (extrai YYYY de YYYY-MM-DD)
                const itemYear = item.data.split('-')[0];
                const matchesYear = (itemYear === currentYear);
                const matchesSearch = item.cliente.toLowerCase().includes(search) || item.tipo.toLowerCase().includes(search);
                return matchesYear && matchesSearch;
            }).sort((a,b) => new Date(b.data) - new Date(a.data));

            filtered.forEach(s => {
                const val = parseFloat(s.valor) || 0;
                c++;
                if(s.status === 'Pago') r += val; else p += val;

                body.innerHTML += `
                    <tr>
                        <td>${s.data.split('-').reverse().join('/')}</td>
                        <td style="font-weight:700;">${s.cliente.toUpperCase()}</td>
                        <td><i class="fa-solid fa-map-pin" style="color:red"></i> ${s.local}</td>
                        <td>${s.tipo}</td>
                        <td><b>R$ ${val.toFixed(2)}</b></td>
                        <td><span class="badge ${s.status === 'Pago' ? 'badge-paid' : 'badge-pending'}" onclick="window.updateStatus('${s.id}', '${s.status}')">${s.status}</span></td>
                        <td><button onclick="window.deleteItem('${s.id}')" style="background:none; border:none; color:#444; cursor:pointer;"><i class="fa-solid fa-trash"></i></button></td>
                    </tr>
                `;
            });

            document.getElementById('kpiRec').innerText = `R$ ${r.toFixed(2)}`;
            document.getElementById('kpiPen').innerText = `R$ ${p.toFixed(2)}`;
            document.getElementById('kpiAvg').innerText = c > 0 ? `R$ ${(r/c).toFixed(2)}` : 'R$ 0,00';
            
            if(document.getElementById('view-stats').classList.contains('active')) buildStats();
        }

        // NAVEGAÇÃO
        document.querySelectorAll('.nav-item').forEach(btn => {
            btn.addEventListener('click', () => {
                const view = btn.dataset.view;
                if(!view) return;

                document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                if(view === 'stats') {
                    document.getElementById('view-main').classList.remove('active');
                    document.getElementById('view-stats').classList.add('active');
                    buildStats();
                } else {
                    currentYear = view;
                    document.getElementById('viewTitle').innerText = `Serviços ${currentYear}`;
                    document.getElementById('view-stats').classList.remove('active');
                    document.getElementById('view-main').classList.add('active');
                    renderAll();
                }
            });
        });

        document.getElementById('searchInput').addEventListener('input', renderAll);

        function buildStats() {
            const list = document.getElementById('statsClients');
            list.innerHTML = '';
            const cMap = {};
            let t = 0, p = 0;

            localData.filter(s => s.data.startsWith(currentYear)).forEach(s => {
                const v = parseFloat(s.valor) || 0;
                t += v;
                if(s.status === 'Pago') p += v;
                cMap[s.cliente] = (cMap[s.cliente] || 0) + v;
            });

            Object.entries(cMap).sort((a,b) => b[1]-a[1]).slice(0,5).forEach(([n, v]) => {
                list.innerHTML += `<div style="display:flex; justify-content:space-between; padding:12px; background:rgba(255,255,255,0.03); border-radius:10px; margin-bottom:8px;">
                    <span>${n}</span><span style="color:var(--success); font-weight:700;">R$ ${v.toFixed(2)}</span>
                </div>`;
            });

            const perc = t > 0 ? (p/t)*100 : 0;
            document.getElementById('percLabel').innerText = Math.round(perc) + '%';
        }
    </script>
</body>
</html>
