<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insect Control Tupy - Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* ========================================= */
        /* VARIÁVEIS DE TEMA E CORES AJUSTADAS */
        /* ========================================= */
        :root {
            --primary-color: #CC0000; /* Vermelho Tupy */
            --primary-light: #AA0000; /* Vermelho Hover */
            --secondary-color: #00BCD4; /* Azul Ciano (Destaque) */
            --danger-color: #d32f2f; 
            --success-color: #4CAF50; /* Verde mais escuro */
            --info-color: #29b6f6;
            
            /* Cores Escuras do Tema */
            --background-body: #121212; /* Fundo principal escuro */
            --card-background: #1E1E1E; /* Fundo dos Cards/Seções */
            --text-dark: #FAFAFA; /* Texto Principal */
            --text-light: #B0B0B0; /* Texto Secundário */
            --table-header-bg: #272727;
            --shadow-light: 0 4px 10px rgba(0, 0, 0, 0.5);
            --shadow-hover: 0 8px 18px rgba(0, 0, 0, 0.8);
            --border-radius: 6px;
            --sidebar-width: 260px;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-body);
            color: var(--text-dark);
        }
        
        /* Layout */
        .dashboard-layout {
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            min-height: 100vh;
            transition: grid-template-columns 0.3s ease;
        }
        .sidebar {
            background-color: var(--primary-color);
            color: white;
            padding: 30px 20px;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.4);
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }
        .logo-box { text-align: center; margin-bottom: 50px; }
        .logo-box img { 
            width: 150px;
            height: 150px; /* Tornando o logo quadrado */
            max-width: 100%;
            margin-bottom: 15px; 
            border-radius: 50%;
            background-color: white; 
            padding: 5px;
            object-fit: contain; 
            border: 3px solid var(--text-dark); /* Borda em torno do logo */
        }
        .logo-box h2 { font-size: 24px; font-weight: 700; margin: 0; color: var(--text-dark); letter-spacing: 1px; }

        /* Navegação */
        .nav-link {
            display: flex; align-items: center; padding: 14px 15px; margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.85); border-radius: var(--border-radius);
            transition: all 0.2s ease-in-out; cursor: pointer; font-weight: 500;
        }
        .nav-link i { margin-right: 18px; font-size: 16px; }
        .nav-link.active, .nav-link:hover {
            background-color: var(--primary-light); 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4); 
            color: var(--text-dark); /* Cor do texto no hover */
        }
        .main-content { padding: 30px 40px; }
        .content-view { display: none; animation: fadeIn 0.4s ease-out; }
        .content-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Componentes */
        .page-header h1 { color: var(--text-dark); border-left: 4px solid var(--secondary-color); padding-left: 15px; }
        .page-header p { color: var(--text-light); }

        /* Cartões KPI */
        .summary-cards { display: flex; gap: 20px; margin-bottom: 40px; }
        .card { 
            background-color: var(--card-background); padding: 25px; border-radius: var(--border-radius); 
            box-shadow: var(--shadow-light); flex: 1; border-left: 4px solid var(--info-color); 
            transition: all 0.3s; 
        }
        .card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); }
        .card h3 { color: var(--text-light); font-size: 14px; margin-top: 0; }
        .card p { color: var(--secondary-color); font-size: 28px; font-weight: 700; margin: 5px 0 0 0; }

        /* Formulário e Inputs */
        .form-section { background-color: var(--card-background); padding: 30px; border-radius: var(--border-radius); box-shadow: var(--shadow-light); margin-bottom: 40px; }
        .form-section h2 { color: var(--text-dark); border-bottom: 1px solid #333; padding-bottom: 15px; margin-top: 0; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 140px; gap: 20px; } 
        .input-group input, .input-group select { 
            width: 100%; box-sizing: border-box; background-color: #272727; color: var(--text-dark); 
            border: 1px solid #444; padding: 12px 15px; border-radius: 4px; 
        }
        .input-group input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }
        .btn-submit { 
            background-color: var(--success-color); color: white; border: none; cursor: pointer;
            padding: 12px 15px; border-radius: 4px; font-weight: 500; transition: background-color 0.2s;
        }
        .btn-submit:hover { background-color: #388E3C; }

        /* Controles de Dados */
        .data-controls { display: flex; gap: 15px; margin-bottom: 25px; align-items: center; }
        .data-controls input { flex-grow: 1; }
        .data-controls input, .data-controls select { 
            background-color: var(--card-background); color: var(--text-dark); border-color: #444; 
            padding: 10px 15px; border-radius: 4px;
        }

        /* Botão Exportar */
        .export-btn { 
            background-color: var(--secondary-color); color: var(--card-background); border: none; 
            padding: 10px 15px; border-radius: 4px; font-weight: 500; cursor: pointer; transition: background-color 0.2s;
        }
        .export-btn:hover { background-color: #008C9A; }
        
        /* Tabela */
        .data-table-container { background-color: var(--card-background); box-shadow: var(--shadow-light); border-radius: var(--border-radius); overflow: auto; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 15px; text-align: left; }
        .data-table thead { background-color: var(--table-header-bg); }
        .data-table th { color: var(--text-light); border-bottom: 2px solid #333; font-weight: 500; }
        .data-table td { border-bottom: 1px solid #282828; color: var(--text-dark); }
        .data-table tbody tr:hover { background-color: #272727; }

        /* Status Badges */
        .status-badge { 
            padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; 
            transition: all 0.2s ease-in-out; text-align: center; display: inline-block;
        }
        .status-pendente { background-color: #3E2723; color: #FF9800; border: 1px solid #FF9800; }
        .status-pago { background-color: #1B5E20; color: #81C784; border: 1px solid #81C784; }

        /* Edição Inline */
        .editable:hover { cursor: pointer; background-color: #272727; }
        .edit-input { border: 1px solid var(--secondary-color); padding: 5px; width: 90%; border-radius: 3px; font-size: 14px; background-color: #121212; color: var(--text-dark); }
        
        /* Botão Deletar */
        .btn-delete { background: var(--danger-color); color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; transition: background 0.2s; }
        .btn-delete:hover { background: #B71C1C; }

        /* Modais */
        .modal { 
            display: flex; justify-content: center; align-items: center; 
            position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.85); 
        }
        .modal-content { 
            background: var(--card-background); padding: 30px; border-radius: var(--border-radius); 
            box-shadow: var(--shadow-hover); width: 100%; max-width: 400px; text-align: center;
        }
        .modal-content input { 
            background-color: #272727; color: var(--text-dark); border: 1px solid #444; 
            padding: 12px; margin-bottom: 15px; width: calc(100% - 24px); border-radius: 4px;
        }
        .modal-content button { 
            padding: 10px 20px; margin-top: 10px; border: none; border-radius: 4px;
            font-weight: 500; cursor: pointer; background: var(--primary-color); color: white;
            transition: background 0.2s; width: 100%;
        }
        .modal-content button:hover { background: var(--primary-light); }
        .modal-content .btn-google { background: #4285F4; margin-top: 20px; }
        .modal-content .btn-google:hover { background: #3c77e0; }
        
        /* Estatísticas detalhadas */
        .stats-list { list-style: none; padding: 0; margin: 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .stats-item { background-color: #272727; padding: 20px; border-radius: var(--border-radius); box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4); border-left: 4px solid var(--secondary-color); }
        .stats-item h4 { color: var(--text-light); margin-top: 0; }
        .stats-item p { color: var(--text-dark); font-size: 20px; font-weight: 700; }

        /* Toast Notifications */
        #toastContainer { position: fixed; bottom: 20px; right: 20px; z-index: 10000; }
        .toast {
            background-color: var(--success-color); color: white; padding: 15px 20px; border-radius: 4px;
            margin-top: 10px; box-shadow: var(--shadow-light); opacity: 0; transform: translateX(100%);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out; display: flex; align-items: center;
        }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.error { background-color: var(--danger-color); }
        .toast.info { background-color: var(--info-color); }
        .toast i { margin-right: 10px; }

        /* RESPONSIVIDADE (MOBILE) */
        @media (max-width: 992px) {
            .dashboard-layout { grid-template-columns: 1fr; }
            .main-content { padding: 20px; }
            .sidebar { 
                position: sticky; top: 0; height: auto; padding: 15px 10px; 
                display: flex; flex-direction: row; justify-content: flex-start;
                overflow-x: auto; white-space: nowrap; z-index: 1000;
            }
            .logo-box { display: flex; align-items: center; margin-right: 20px; margin-bottom: 0; min-width: 150px; }
            .logo-box img { width: 40px; height: 40px; margin-right: 10px; margin-bottom: 0; border: none; }
            .logo-box h2 { font-size: 18px; color: white; }
            
            .nav-link { margin-bottom: 0; padding: 10px 15px; }
            .nav-link i { margin-right: 8px; }
            
            .summary-cards { flex-direction: column; }
            .form-grid { grid-template-columns: 1fr; gap: 15px; }
            .form-grid > div, .form-grid button { grid-column: 1 / -1 !important; }
            .data-controls { flex-direction: column; align-items: stretch; }
        }

        /* Tabela Responsiva (Mobile) */
        @media (max-width: 768px) {
            .data-table thead { display: none; }
            .data-table, .data-table tbody, .data-table tr, .data-table td { display: block; width: 100%; }
            .data-table tr { margin-bottom: 15px; border: 1px solid #333; border-radius: var(--border-radius); box-shadow: var(--shadow-light); background-color: var(--card-background); }
            .data-table td { text-align: right; padding: 10px; position: relative; border-bottom: none; }
            .data-table td:before { content: attr(data-label); float: left; font-weight: 500; text-transform: uppercase; color: var(--text-light); font-size: 13px; }
        }
    </style>
</head>
<body>

    <div id="toastContainer"></div>

    <div class="dashboard-layout" id="mainDashboard" style="display: none;">
        
        <div class="sidebar">
            <div class="logo-box">
                <img src="logo.png.JPG" alt="Insect Control Tupy Logo">
                <h2>Insect Tupí</h2>
            </div>
            
            <div class="nav-link active" data-view="servicos">
                <i class="fas fa-clipboard-list"></i>
                <span>Serviços</span>
            </div>
            
            <div class="nav-link" data-view="resumo">
                <i class="fas fa-chart-line"></i>
                <span>Resumo Financeiro</span>
            </div>
            
            <div class="nav-link" style="margin-top: 50px;" onclick="window.logout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Sair</span>
            </div>
        </div>

        <div class="main-content">
            
            <div id="view-servicos" class="content-view active">
                
                <div class="page-header">
                    <h1>Painel de Serviços</h1>
                    <p>Visão geral, registro e gestão de atendimentos.</p>
                </div>

                <div class="summary-cards">
                    <div class="card" style="border-left-color: var(--secondary-color);">
                        <h3>TOTAL DE SERVIÇOS</h3>
                        <p id="totalServicos">0</p>
                    </div>
                    <div class="card" style="border-left-color: var(--success-color);">
                        <h3>VALOR TOTAL (R$)</h3>
                        <p id="valorTotal">R$ 0,00</p>
                    </div>
                    <div class="card" style="border-left-color: var(--info-color);">
                        <h3>SERVIÇOS NO MÊS</h3>
                        <p id="servicosMes">0</p>
                    </div>
                    <div class="card" style="border-left-color: var(--danger-color);">
                        <h3>PENDÊNCIAS (R$)</h3>
                        <p id="valorPendente">R$ 0,00</p>
                    </div>
                </div>

                <div class="form-section">
                    <h2><i class="fas fa-plus-circle"></i> Registrar Novo Serviço</h2>
                    <form id="formServico">
                        <div class="form-grid">
                            
                            <div class="input-group"><input type="date" id="data" required></div>
                            <div class="input-group"><input type="text" id="cliente" placeholder="Nome do Cliente" required></div>
                            <div class="input-group">
                                <input type="text" id="tipo" placeholder="Descreva o Serviço (ex: Dedetização Geral)" required>
                            </div>
                            
                            <div class="input-group"><input type="number" id="valor" placeholder="Valor (R$)" step="0.01" required></div>
                            
                            <button type="submit" class="btn-submit"><i class="fas fa-check"></i> Salvar</button>

                            <div class="input-group"><input type="text" id="local" placeholder="Local/Endereço" required></div>

                            <div class="input-group"><input type="text" id="contato" placeholder="Contato" required></div>
                        </div>
                    </form>
                </div>
                
                <div class="data-controls">
                    <input type="text" id="searchInput" placeholder="Buscar por cliente, local, tipo ou contato...">
                    <button class="export-btn" id="exportCsvBtn"><i class="fas fa-download"></i> Exportar CSV</button>
                </div>

                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Cliente</th>
                                <th>Local</th>
                                <th>Tipo</th>
                                <th>Contato</th>
                                <th>Valor (R$)</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="servicosList">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="view-resumo" class="content-view">
                <div class="page-header">
                    <h1><i class="fas fa-chart-bar"></i> Análise e Estatísticas</h1>
                    <p>Indicadores chave de performance (KPIs) e tendências do negócio.</p>
                </div>
                
                <div class="summary-cards">
                    <div class="card" style="border-left-color: var(--success-color);">
                        <h3>FATURAMENTO TOTAL</h3>
                        <p id="resumoValorTotal">R$ 0,00</p>
                    </div>
                    <div class="card" style="border-left-color: var(--secondary-color);">
                        <h3>TAXA DE SERVIÇOS PAGOS</h3>
                        <p id="taxaPagos">0%</p>
                    </div>
                    <div class="card" style="border-left-color: var(--primary-color);">
                        <h3>MÉDIA DE VALOR/SERVIÇO</h3>
                        <p id="resumoMediaValor">R$ 0,00</p>
                    </div>
                    <div class="card" style="border-left-color: var(--info-color);">
                        <h3>SERVIÇO MAIS RENTÁVEL</h3>
                        <p id="resumoMaisRentavel">---</p>
                    </div>
                </div>

                <div class="form-section">
                    <h2>Estatísticas Detalhadas</h2>
                    <ul class="stats-list" id="statsList">
                        <li class="stats-item highlight"><h4>Serviço Mais Comum</h4><p id="statsMaisComum">---</p></li>
                        <li class="stats-item"><h4>Valor Máximo de um Serviço</h4><p id="statsValorMax">R$ 0,00</p></li>
                        <li class="stats-item"><h4>Valor Mínimo de um Serviço</h4><p id="statsValorMin">R$ 0,00</p></li>
                    </ul>
                </div>
            </div>

        </div>
    </div>
    
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h4>Login</h4>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="senha" placeholder="Senha">
            <button onclick="window.login()">Login</button>
            <button onclick="window.showCadastro()">Cadastrar-se</button>
            <button onclick="window.loginGoogle()" class="btn-google">Entrar com Google</button>
        </div>
    </div>
    <div id="cadastroModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h4>Cadastrar-se</h4>
            <input type="email" id="emailCadastro" placeholder="Email">
            <input type="password" id="senhaCadastro" placeholder="Senha">
            <button onclick="window.cadastrar()">Cadastrar</button>
            <button onclick="window.showLogin()">Já tem uma conta? Entrar</button>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js"></script>

    <script type="module">
        // Importações do Firebase v9 Modular
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, query, where, updateDoc } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

        // 1. SUA CONFIGURAÇÃO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCIU7yiuI1uXfJWv6MoGYTv6ylqhzQhscA",
            authDomain: "insectcontrol-54785.firebaseapp.com",
            projectId: "insectcontrol-54785",
            storageBucket: "insectcontrol-54785.appspot.com",
            messagingSenderId: "299720867487",
            appId: "1:299720867487:web:cdcff964efc45755496caa",
            measurementId: "G-DVQWP5TM9J"
        };
        
        // Inicialização e referências
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const servicosCol = "servicos";

        let userEmail = null;
        let servicos = []; 

        // Funções globais de utilidade
        window.formatarMoeda = (valor) => parseFloat(valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        window.mostrarToast = (message, type = 'success') => {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.classList.add('toast', type);
            const icon = type === 'success' ? 'fas fa-check-circle' : type === 'error' ? 'fas fa-exclamation-triangle' : 'fas fa-info-circle';
            toast.innerHTML = `<i class="${icon}"></i> <span>${message}</span>`;
            
            container.appendChild(toast);
            void toast.offsetWidth; 
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        };
        
        // --- FUNÇÕES FIREBASE (AUTH) ---

        window.login = () => {
            const email = document.getElementById("email").value;
            const senha = document.getElementById("senha").value;
            signInWithEmailAndPassword(auth, email, senha)
                .then(() => mostrarToast("Login realizado com sucesso!", 'success'))
                .catch(err => mostrarToast("Erro no login: " + err.message, 'error'));
        };

        window.cadastrar = () => {
            const email = document.getElementById("emailCadastro").value;
            const senha = document.getElementById("senhaCadastro").value;
            createUserWithEmailAndPassword(auth, email, senha)
                .then(() => mostrarToast("Cadastro realizado com sucesso! Faça login.", 'success'))
                .catch(err => mostrarToast("Erro no cadastro: " + err.message, 'error'));
        };
        
        window.loginGoogle = () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .then(() => mostrarToast("Login com Google realizado com sucesso!", 'success'))
                .catch(err => mostrarToast("Erro no login com Google: " + err.message, 'error'));
        };

        window.logout = () => {
            signOut(auth).then(() => {
                mostrarToast('Desconectado com sucesso!', 'info');
            });
        };

        window.showCadastro = () => {
            document.getElementById("loginModal").style.display = "none";
            document.getElementById("cadastroModal").style.display = "flex";
        };

        window.showLogin = () => {
            document.getElementById("cadastroModal").style.display = "none";
            document.getElementById("loginModal").style.display = "flex";
        };
        
        // --- FUNÇÕES FIRESTORE (CRUD) ---

        async function carregarServicos() {
            if (!userEmail) return;
            const q = query(collection(db, servicosCol), where("usuario", "==", userEmail));
            const snap = await getDocs(q);
            
            servicos = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            // Ordenar por data mais recente primeiro
            servicos.sort((a, b) => new Date(b.data.replace(/-/g, '/')) - new Date(a.data.replace(/-/g, '/')));

            renderizarServicos();
            renderizarEstatisticas();
        }
        
        document.getElementById('formServico').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userEmail) return mostrarToast("Por favor, faça login para adicionar um serviço.", 'error');

            const novoServico = {
                data: document.getElementById('data').value,
                cliente: document.getElementById('cliente').value.trim(),
                local: document.getElementById('local').value.trim(),
                tipo: document.getElementById('tipo').value.trim(),
                contato: document.getElementById('contato').value.trim(),
                valor: (parseFloat(document.getElementById('valor').value) || 0).toFixed(2),
                status: 'Pendente', 
                usuario: userEmail,
                criado: new Date().toISOString()
            };

            try {
                // Preenchimento do endereço/contato faltando na primeira linha do grid. Movido para a segunda linha no HTML.
                await addDoc(collection(db, servicosCol), novoServico);
                document.getElementById('formServico').reset();
                mostrarToast('Novo Serviço registrado com sucesso!', 'success');
                carregarServicos();
            } catch (error) {
                mostrarToast(`Erro ao salvar serviço: ${error.message}`, 'error');
            }
        });

        window.deletarServico = async (id) => {
            const servicoParaDeletar = servicos.find(s => s.id === id);
            
            if (confirm(`Tem certeza que deseja excluir o serviço de ${servicoParaDeletar.cliente} em ${servicoParaDeletar.data}?`)) {
                try {
                    await deleteDoc(doc(db, servicosCol, id));
                    mostrarToast('Serviço excluído!', 'error');
                    carregarServicos();
                } catch (error) {
                    mostrarToast(`Erro ao excluir serviço: ${error.message}`, 'error');
                }
            }
        };

        window.toggleStatus = async (id) => {
            const servicoRef = doc(db, servicosCol, id);
            const servico = servicos.find(s => s.id === id);
            const newStatus = (servico.status === 'Pendente') ? 'Pago' : 'Pendente';

            try {
                await updateDoc(servicoRef, { status: newStatus });
                mostrarToast(`Status do serviço atualizado para: ${newStatus}`, 'info');
                carregarServicos();
            } catch (error) {
                mostrarToast(`Erro ao atualizar status: ${error.message}`, 'error');
            }
        };

        async function updateServicoField(id, field, newValue) {
            const servicoRef = doc(db, servicosCol, id);
            try {
                await updateDoc(servicoRef, { [field]: newValue });
                mostrarToast('Serviço atualizado com sucesso!', 'success');
                carregarServicos();
            } catch (error) {
                mostrarToast(`Erro ao atualizar serviço: ${error.message}`, 'error');
            }
        }
        
        // --- RENDERING ---
        
        window.enableInlineEditing = (element, field, id) => {
            element.classList.add('editable');
            // Remove o handler anterior antes de adicionar um novo
            element.ondblclick = null; 
            
            element.ondblclick = function handler() {
                const servico = servicos.find(s => s.id === id);
                if (!servico) return;

                // Remove R$ e formatação de moeda para obter o valor base
                const oldValueText = element.textContent.trim();
                const isValue = field === 'valor';
                
                const oldValue = isValue 
                    ? (parseFloat(oldValueText.replace('R$', '').replace('.', '').replace(',', '.').replace(/\s/g, '')) || 0)
                    : oldValueText;

                const input = document.createElement('input');
                input.className = 'edit-input';
                input.type = isValue ? 'number' : 'text';
                input.step = isValue ? '0.01' : null;
                input.value = isValue ? oldValue.toFixed(2) : oldValue; 
                
                element.innerHTML = '';
                element.appendChild(input);
                input.focus();

                const saveChange = () => {
                    const newValue = input.value.trim();
                    
                    if (newValue === (isValue ? oldValue.toFixed(2) : oldValue)) {
                        // Se não houver alteração, restaura e sai
                        element.textContent = isValue ? window.formatarMoeda(oldValue) : oldValueText;
                        return;
                    }

                    const finalValue = isValue ? (parseFloat(newValue) || 0).toFixed(2) : newValue;
                    updateServicoField(id, field, finalValue);
                };

                input.addEventListener('blur', saveChange);
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') saveChange();
                });
                
                // Re-adiciona o double click handler quando o campo perde o foco
                input.addEventListener('blur', () => {
                    element.ondblclick = handler;
                });
                element.ondblclick = null; 
            };
        };

        function renderizarServicos() {
            const list = document.getElementById('servicosList');
            list.innerHTML = '';
            
            const termoBusca = document.getElementById('searchInput').value.toLowerCase();

            const listaFiltrada = servicos.filter(servico => {
                const matchesSearch = termoBusca === '' || 
                                        servico.cliente.toLowerCase().includes(termoBusca) ||
                                        servico.local.toLowerCase().includes(termoBusca) ||
                                        servico.tipo.toLowerCase().includes(termoBusca) ||
                                        servico.contato.toLowerCase().includes(termoBusca);
                return matchesSearch;
            });

            if (listaFiltrada.length === 0) {
                list.innerHTML = `<tr><td colspan="8" style="text-align:center; padding: 20px; color: var(--text-light);">Nenhum serviço encontrado.</td></tr>`;
                return;
            }

            listaFiltrada.forEach(servico => {
                const row = list.insertRow();
                const statusClass = servico.status === 'Pago' ? 'status-pago' : 'status-pendente';
                
                row.innerHTML = `
                    <td data-label="Data">${servico.data}</td>
                    <td data-label="Cliente" class="editable" data-field="cliente">${servico.cliente}</td>
                    <td data-label="Local" class="editable" data-field="local">${servico.local}</td>
                    <td data-label="Tipo" class="editable" data-field="tipo">${servico.tipo}</td>
                    <td data-label="Contato" class="editable" data-field="contato">${servico.contato}</td>
                    <td data-label="Valor (R$)" class="editable" data-field="valor" style="font-weight: 600;">${window.formatarMoeda(servico.valor)}</td>
                    <td data-label="Status">
                        <span class="status-badge ${statusClass}" onclick="window.toggleStatus('${servico.id}')">
                            ${servico.status}
                        </span>
                    </td>
                    <td>
                        <button class="btn-delete" onclick="window.deletarServico('${servico.id}')"><i class="fas fa-trash-alt"></i></button>
                    </td>
                `;

                row.querySelectorAll('.editable').forEach(cell => {
                    window.enableInlineEditing(cell, cell.dataset.field, servico.id);
                });
            });
        }
        
        function renderizarEstatisticas() {
            const totalServicos = servicos.length;
            const valorTotalSoma = servicos.reduce((soma, servico) => soma + (parseFloat(servico.valor) || 0), 0);
            const mediaValor = totalServicos > 0 ? valorTotalSoma / totalServicos : 0;
            const valorPendenteSoma = servicos.filter(s => s.status !== 'Pago').reduce((soma, servico) => soma + (parseFloat(servico.valor) || 0), 0);
            const totalPagos = servicos.filter(s => s.status === 'Pago').length;
            const taxaPagos = totalServicos > 0 ? ((totalPagos / totalServicos) * 100).toFixed(1) : 0;

            const tipoStats = {};
            servicos.forEach(servico => {
                if (!tipoStats[servico.tipo]) tipoStats[servico.tipo] = { count: 0, totalValue: 0 };
                tipoStats[servico.tipo].count += 1;
                tipoStats[servico.tipo].totalValue += (parseFloat(servico.valor) || 0);
            });

            let maisComum = { tipo: '---', count: 0 };
            let maisRentavel = { tipo: '---', totalValue: 0 };

            Object.keys(tipoStats).forEach(tipo => {
                if (tipoStats[tipo].count > maisComum.count) maisComum = { tipo: tipo, count: tipoStats[tipo].count };
                if (tipoStats[tipo].totalValue > maisRentavel.totalValue) maisRentavel = { tipo: tipo, totalValue: tipoStats[tipo].totalValue };
            });
            
            const valores = servicos.map(s => parseFloat(s.valor) || 0);
            const valorMax = valores.length > 0 ? Math.max(...valores) : 0;
            const valorMin = valores.length > 0 ? Math.min(...valores) : 0;
            
            const dataAtual = new Date();
            const mesAtual = dataAtual.getMonth();
            const anoAtual = dataAtual.getFullYear();
            const servicosMes = servicos.filter(s => {
                const dataServico = new Date(s.data.replace(/-/g, '/'));
                return dataServico.getMonth() === mesAtual && dataServico.getFullYear() === anoAtual;
            }).length;

            const stats = { totalServicos, valorTotalSoma, servicosMes, mediaValor, valorPendenteSoma, totalPagos, taxaPagos, maisComum: maisComum.tipo, maisRentavel: maisRentavel.tipo, valorMax, valorMin };
            
            // Renderização
            document.getElementById('totalServicos').textContent = stats.totalServicos;
            document.getElementById('valorTotal').textContent = window.formatarMoeda(stats.valorTotalSoma);
            document.getElementById('servicosMes').textContent = stats.servicosMes;
            document.getElementById('valorPendente').textContent = window.formatarMoeda(stats.valorPendenteSoma);
            
            document.getElementById('resumoValorTotal').textContent = window.formatarMoeda(stats.valorTotalSoma);
            document.getElementById('resumoMediaValor').textContent = window.formatarMoeda(stats.mediaValor);
            document.getElementById('resumoMaisRentavel').textContent = stats.maisRentavel;
            document.getElementById('taxaPagos').textContent = `${stats.taxaPagos}%`;
            
            document.getElementById('statsMaisComum').textContent = stats.maisComum;
            document.getElementById('statsValorMax').textContent = window.formatarMoeda(stats.valorMax);
            document.getElementById('statsValorMin').textContent = window.formatarMoeda(stats.valorMin);
        }

        // CORREÇÃO: Adicionando um pequeno debounce para otimizar o filtro
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('keyup', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(renderizarServicos, 300); // Espera 300ms após a última tecla
        });
        
        document.getElementById('exportCsvBtn').addEventListener('click', () => {
            if (servicos.length === 0) {
                mostrarToast('Nenhum dado para exportar.', 'info');
                return;
            }

            const headers = ['Data', 'Cliente', 'Local', 'Tipo', 'Contato', 'Valor', 'Status'];
            const data = servicos.map(s => [
                s.data, s.cliente, s.local, s.tipo, s.contato, s.valor.replace('.', ','), s.status
            ]);

            let csvContent = headers.join(';') + '\n';
            data.forEach(row => {
                csvContent += row.join(';') + '\n';
            });

            // Adiciona o BOM para garantir compatibilidade com acentos no Excel
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'servicos_insect_control.csv');
            link.click();
            mostrarToast('Dados exportados para CSV!', 'success');
        });

        const navLinks = document.querySelectorAll('.nav-link');
        const contentViews = document.querySelectorAll('.content-view');

        navLinks.forEach(link => {
            link.addEventListener('click', () => {
                const targetViewId = link.getAttribute('data-view');
                
                navLinks.forEach(l => l.classList.remove('active'));
                contentViews.forEach(v => v.classList.remove('active'));
                
                link.classList.add('active');
                document.getElementById(`view-${targetViewId}`).classList.add('active');

                if (targetViewId === 'servicos' || targetViewId === 'resumo') {
                    // Recarrega os dados ao trocar de view
                    carregarServicos(); 
                }
            });
        });

        // --- INICIALIZAÇÃO E AUTENTICAÇÃO ---
        onAuthStateChanged(auth, (user) => {
            const dashboard = document.getElementById('mainDashboard');
            const loginModal = document.getElementById('loginModal');
            const cadastroModal = document.getElementById('cadastroModal');

            if (user) {
                userEmail = user.email;
                dashboard.style.display = "grid";
                loginModal.style.display = "none";
                cadastroModal.style.display = "none";
                carregarServicos(); 
            } else {
                userEmail = null;
                dashboard.style.display = "none";
                loginModal.style.display = "flex";
                cadastroModal.style.display = "none";
                servicos = [];
            }
        });

    </script>
</body>
</html>
